#!/bin/python3

from gcd.meka import cmd, rule, os, path, sh, meka


@rule
def liftup(from_path, to_path, to_type):
    yield from_path, to_path
    sh(('liftup -o %s -t %s %s', to_path, to_type, from_path))
    if to_type == 'html' and not path.exists(to_path[:-5]):
        os.symlink(to_path[5:], to_path[:-5])


@cmd.run
def main():
    'Publish all changes to output directory.'
    meka(False)
    cmd.arg('--html', '-H', action='store_true',
            help='Also generate html output.')
    yield
    if not path.exists('output'):
        raise FileNotFoundError(
            'The wiki repo must reside at output subdirectory.')
    if cmd.args.html and not path.exists('html'):
        os.makedirs('html')
    for subdir, dirs, files in os.walk('.'):
        if subdir == '.':
            dirs.remove('output')
            dirs.remove('.git')
            out_prefix = ''
        else:
            out_prefix = subdir.lstrip('./').replace('/', '-') + '-'
        for in_file in files:
            if not in_file.endswith('.md'):
                continue
            in_path = subdir + '/' + in_file
            out_path = 'output/' + out_prefix + in_file
            liftup(in_path, out_path, 'github')
            if cmd.args.html:
                html_path = 'html/' + out_prefix + in_file[:-3] + '.html'
                liftup(out_path, html_path, 'html')
